# Implementation Examples & Code Reference\n\n## Backend Implementation\n\n### 1. Admin Controller - getSignupStats Function\n\n**File:** `/backend/src/controllers/adminController.ts`\n\n```typescript\nexport const getSignupStats = async (req: AuthRequest, res: Response, next: NextFunction): Promise<void> => {\n  try {\n    // Get total users\n    const totalUsers = await User.countDocuments()\n\n    // Get new users in the last 7 days\n    const sevenDaysAgo = new Date()\n    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)\n    const newUsersLast7Days = await User.countDocuments({\n      createdAt: { $gte: sevenDaysAgo }\n    })\n\n    // Get daily signups for the last 30 days using aggregation\n    const thirtyDaysAgo = new Date()\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)\n\n    const dailySignupsAggregation = await User.aggregate([\n      {\n        $match: {\n          createdAt: { $gte: thirtyDaysAgo }\n        }\n      },\n      {\n        $group: {\n          _id: {\n            year: { $year: '$createdAt' },\n            month: { $month: '$createdAt' },\n            day: { $dayOfMonth: '$createdAt' }\n          },\n          count: { $sum: 1 }\n        }\n      },\n      {\n        $sort: { '_id.year': 1, '_id.month': 1, '_id.day': 1 }\n      }\n    ])\n\n    // Format daily signups into array with date strings\n    const dailySignups = dailySignupsAggregation.map(item => {\n      const date = new Date(\n        item._id.year,\n        item._id.month - 1,\n        item._id.day\n      )\n      return {\n        date: date.toISOString().split('T')[0], // YYYY-MM-DD format\n        count: item.count\n      }\n    })\n\n    // Get active users\n    const activeUsers = await User.countDocuments({\n      lastLogin: { $gte: sevenDaysAgo },\n      isActive: true\n    })\n\n    // Get subscription breakdown\n    const subscriptionBreakdown = await User.aggregate([\n      {\n        $group: {\n          _id: '$subscription.plan',\n          count: { $sum: 1 }\n        }\n      }\n    ])\n\n    const subscriptionStats = {\n      starter: subscriptionBreakdown.find(s => s._id === 'starter')?.count || 0,\n      professional: subscriptionBreakdown.find(s => s._id === 'professional')?.count || 0,\n      enterprise: subscriptionBreakdown.find(s => s._id === 'enterprise')?.count || 0\n    }\n\n    res.status(200).json({\n      success: true,\n      data: {\n        totalUsers,\n        newUsersLast7Days,\n        activeUsers,\n        subscriptionStats,\n        dailySignups\n      }\n    })\n  } catch (error) {\n    logger.error('Get signup stats error:', error)\n    next(error)\n  }\n}\n```\n\n### 2. Admin Routes\n\n**File:** `/backend/src/routes/admin.ts`\n\n```typescript\nimport express from 'express'\nimport { body } from 'express-validator'\nimport { getAdminUsers, getSystemMetrics, getSystemLogs, broadcastNotification, getSignupStats } from '../controllers/adminController'\nimport { protect, authorize } from '../middleware/auth'\n\nconst router = express.Router()\n\n// All admin routes require admin role\nrouter.use(protect)\nrouter.use(authorize('admin'))\n\n// @route   GET /api/admin/stats\n// @desc    Get signup analytics and user stats\n// @access  Private/Admin\nrouter.get('/stats', getSignupStats)\n\n// ... other routes ...\n\nexport default router\n```\n\n### 3. Authentication Middleware\n\nThe existing middleware in `/backend/src/middleware/auth.ts` handles:\n\n```typescript\nexport const protect = async (req: AuthRequest, res: Response, next: NextFunction): Promise<void> => {\n  // ✓ Validates JWT token from Bearer header or cookies\n  // ✓ Retrieves user from database\n  // ✓ Checks if user is active\n  // ✓ Attaches user to req.user\n}\n\nexport const authorize = (...roles: string[]) => {\n  return (req: AuthRequest, res: Response, next: NextFunction): void => {\n    // ✓ Checks if user has required role\n    // ✓ Returns 403 if not authorized\n    // ✓ Proceeds to next middleware if authorized\n  }\n}\n```\n\n## Frontend Implementation\n\n### 1. API Client\n\n**File:** `/frontend/src/lib/api.ts`\n\n```typescript\n// Admin API\nexport interface SignupStats {\n  totalUsers: number;\n  newUsersLast7Days: number;\n  activeUsers: number;\n  subscriptionStats: {\n    starter: number;\n    professional: number;\n    enterprise: number;\n  };\n  dailySignups: Array<{\n    date: string;\n    count: number;\n  }>;\n}\n\nexport const adminApi = {\n  getSignupStats: () =>\n    api.get<ApiResponse<SignupStats>>('/admin/stats', { withCredentials: true }),\n  \n  // ... other admin methods ...\n};\n```\n\n### 2. Admin Dashboard Component\n\n**File:** `/frontend/src/app/dashboard/admin/page.tsx`\n\n```typescript\n'use client'\n\nimport React, { useState, useEffect } from 'react'\nimport { adminApi, SignupStats } from '@/lib/api'\nimport { LineChart, Line, PieChart, Pie, Cell, ResponsiveContainer } from 'recharts'\nimport { Users, TrendingUp } from 'lucide-react'\n\nexport default function AdminDashboard() {\n  const [stats, setStats] = useState<SignupStats | null>(null)\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState<string | null>(null)\n\n  useEffect(() => {\n    fetchStats()\n  }, [])\n\n  const fetchStats = async () => {\n    try {\n      setLoading(true)\n      setError(null)\n      const response = await adminApi.getSignupStats()\n      if (response.data.success && response.data.data) {\n        setStats(response.data.data)\n      } else {\n        setError('Failed to load stats')\n      }\n    } catch (err: any) {\n      const errorMessage = err.response?.data?.error || err.message || 'Failed to fetch stats'\n      setError(errorMessage)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // ... rest of component ...\n}\n```\n\n### 3. Stats Card Component\n\n```typescript\n{/* Total Users Card */}\n<div className=\"bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500\">\n  <div className=\"flex items-center justify-between\">\n    <div>\n      <p className=\"text-slate-600 text-sm font-medium\">Total Users</p>\n      <p className=\"text-3xl font-bold text-slate-900 mt-2\">\n        {stats.totalUsers.toLocaleString()}\n      </p>\n    </div>\n    <div className=\"bg-blue-100 p-3 rounded-lg\">\n      <Users className=\"text-blue-600\" size={24} />\n    </div>\n  </div>\n</div>\n```\n\n### 4. Line Chart for Signup Trends\n\n```typescript\n<div className=\"bg-white rounded-lg shadow-md p-6\">\n  <h2 className=\"text-xl font-bold text-slate-900 mb-4\">Signup Trends (30 Days)</h2>\n  <div className=\"w-full h-80\">\n    <ResponsiveContainer width=\"100%\" height=\"100%\">\n      <LineChart data={stats.dailySignups}>\n        <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n        <XAxis dataKey=\"date\" stroke=\"#94a3b8\" />\n        <YAxis stroke=\"#94a3b8\" />\n        <Tooltip \n          contentStyle={{\n            backgroundColor: '#1e293b',\n            border: 'none',\n            borderRadius: '8px',\n            color: '#f1f5f9'\n          }}\n        />\n        <Legend />\n        <Line \n          type=\"monotone\" \n          dataKey=\"count\" \n          stroke=\"#3b82f6\" \n          strokeWidth={2}\n          dot={{ fill: '#3b82f6', r: 4 }}\n          activeDot={{ r: 6 }}\n          name=\"Signups\"\n        />\n      </LineChart>\n    </ResponsiveContainer>\n  </div>\n</div>\n```\n\n### 5. Pie Chart for Subscriptions\n\n```typescript\n<ResponsiveContainer width=\"100%\" height=\"100%\">\n  <PieChart>\n    <Pie\n      data={[\n        { name: 'Starter', value: stats.subscriptionStats.starter },\n        { name: 'Professional', value: stats.subscriptionStats.professional },\n        { name: 'Enterprise', value: stats.subscriptionStats.enterprise }\n      ]}\n      cx=\"50%\"\n      cy=\"50%\"\n      labelLine={false}\n      label={({ name, value }) => `${name}: ${value}`}\n      outerRadius={80}\n      fill=\"#8884d8\"\n      dataKey=\"value\"\n    >\n      {[0, 1, 2].map((index) => (\n        <Cell key={`cell-${index}`} fill={COLORS[index]} />\n      ))}\n    </Pie>\n    <Tooltip />\n  </PieChart>\n</ResponsiveContainer>\n```\n\n## Usage Examples\n\n### Using the API Directly\n\n```typescript\n// In any React component\nimport { adminApi } from '@/lib/api'\n\nconst data = await adminApi.getSignupStats()\nconsole.log(data.data.data.totalUsers) // 1320\n```\n\n### Displaying Stats in a Component\n\n```typescript\nimport { adminApi } from '@/lib/api'\n\nfunction MyComponent() {\n  const [stats, setStats] = useState(null)\n\n  useEffect(() => {\n    adminApi.getSignupStats()\n      .then(res => setStats(res.data.data))\n      .catch(err => console.error('Error:', err))\n  }, [])\n\n  if (!stats) return <div>Loading...</div>\n\n  return (\n    <div>\n      <h1>Total Users: {stats.totalUsers}</h1>\n      <h2>New This Week: {stats.newUsersLast7Days}</h2>\n    </div>\n  )\n}\n```\n\n## Testing\n\n### Manual Testing with cURL\n\n```bash\n# 1. Login first\ncurl -X POST http://localhost:3001/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"admin@example.com\",\"password\":\"password\"}'\n\n# Response will include a token\n# {\n#   \"success\": true,\n#   \"data\": {\n#     \"user\": {...},\n#     \"token\": \"eyJhbGc...\"\n#   }\n# }\n\n# 2. Use the token to access admin stats\ncurl -X GET http://localhost:3001/api/admin/stats \\\n  -H \"Authorization: Bearer eyJhbGc...\"\n```\n\n### React Testing Library\n\n```typescript\nimport { render, screen, waitFor } from '@testing-library/react'\nimport AdminDashboard from '@/app/dashboard/admin/page'\nimport * as api from '@/lib/api'\n\njest.mock('@/lib/api')\n\ntest('displays total users', async () => {\n  const mockStats = {\n    totalUsers: 100,\n    newUsersLast7Days: 10,\n    activeUsers: 50,\n    subscriptionStats: { starter: 80, professional: 15, enterprise: 5 },\n    dailySignups: [{ date: '2025-10-20', count: 5 }]\n  }\n\n  api.adminApi.getSignupStats.mockResolvedValueOnce({\n    data: { success: true, data: mockStats }\n  })\n\n  render(<AdminDashboard />)\n\n  await waitFor(() => {\n    expect(screen.getByText('100')).toBeInTheDocument()\n  })\n})\n```\n\n## Error Handling\n\n### Backend Error Handling\n\n```typescript\ntry {\n  // Database query\n  const totalUsers = await User.countDocuments()\n  \n  // ... other queries ...\n  \n  // Success response\n  res.status(200).json({\n    success: true,\n    data: { ... }\n  })\n} catch (error) {\n  logger.error('Get signup stats error:', error)\n  next(error) // Passes to error handler middleware\n}\n```\n\n### Frontend Error Handling\n\n```typescript\nconst fetchStats = async () => {\n  try {\n    setLoading(true)\n    setError(null)\n    const response = await adminApi.getSignupStats()\n    if (response.data.success && response.data.data) {\n      setStats(response.data.data)\n    } else {\n      setError('Failed to load stats')\n    }\n  } catch (err: any) {\n    const errorMessage = err.response?.data?.error || err.message || 'Failed to fetch stats'\n    setError(errorMessage)\n    console.error('Error fetching stats:', err)\n  } finally {\n    setLoading(false)\n  }\n}\n```\n\n## Performance Tips\n\n### 1. Database Indexes\n\n```javascript\n// Create indexes for faster queries\ndb.users.createIndex({ \"createdAt\": 1 })\ndb.users.createIndex({ \"lastLogin\": 1 })\ndb.users.createIndex({ \"subscription.plan\": 1 })\n```\n\n### 2. Caching (Optional)\n\n```typescript\nconst cache = new Map()\nconst CACHE_TTL = 5 * 60 * 1000 // 5 minutes\n\nexport const getSignupStats = async (req: AuthRequest, res: Response) => {\n  const cached = cache.get('stats')\n  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n    return res.status(200).json({ success: true, data: cached.data })\n  }\n  \n  // ... fetch and cache ...\n  cache.set('stats', { data: stats, timestamp: Date.now() })\n}\n```\n\n### 3. Query Optimization\n\n```typescript\n// Use projection to only get needed fields\nconst users = await User.find(query)\n  .select('createdAt lastLogin subscription.plan') // Only needed fields\n  .lean() // Return plain objects, not Mongoose documents\n  .skip(skip)\n  .limit(limit)\n```\n\n## Extending the Dashboard\n\n### Add Custom Date Range\n\n```typescript\nconst [dateRange, setDateRange] = useState({\n  start: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000),\n  end: new Date()\n})\n\nconst fetchStats = async (start?: Date, end?: Date) => {\n  // Add query params: ?start=2025-10-20&end=2025-11-03\n  const response = await adminApi.getSignupStats(start, end)\n}\n```\n\n### Add Export to CSV\n\n```typescript\nconst exportToCSV = () => {\n  const csv = stats.dailySignups\n    .map(item => `${item.date},${item.count}`)\n    .join('\\n')\n  \n  const blob = new Blob([`date,signups\\n${csv}`], { type: 'text/csv' })\n  const url = window.URL.createObjectURL(blob)\n  const a = document.createElement('a')\n  a.href = url\n  a.download = 'signup-stats.csv'\n  a.click()\n}\n```\n\n---\n\n**Note:** All examples follow TypeScript best practices and integrate with your existing Klya AI codebase.\n"